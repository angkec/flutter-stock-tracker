import 'dart:typed_data';

/// GBK to Unicode decoder for Chinese stock names
///
/// GBK is a 2-byte encoding for Chinese characters:
/// - First byte range: 0x81-0xFE
/// - Second byte range: 0x40-0x7E and 0x80-0xFE
class GbkDecoder {
  /// Decode GBK-encoded bytes to a Unicode string
  static String decode(Uint8List bytes) {
    // Remove trailing null bytes
    var end = bytes.length;
    while (end > 0 && bytes[end - 1] == 0) {
      end--;
    }

    final result = StringBuffer();
    var i = 0;

    while (i < end) {
      final byte1 = bytes[i];

      // Check if this is a GBK double-byte character
      // First byte must be in range 0x81-0xFE
      if (byte1 >= 0x81 && byte1 <= 0xFE && i + 1 < end) {
        final byte2 = bytes[i + 1];

        // Second byte must be in range 0x40-0x7E or 0x80-0xFE
        if ((byte2 >= 0x40 && byte2 <= 0x7E) ||
            (byte2 >= 0x80 && byte2 <= 0xFE)) {
          final gbkCode = (byte1 << 8) | byte2;
          final unicode = _gbkToUnicode[gbkCode];

          if (unicode != null) {
            result.writeCharCode(unicode);
          } else {
            // Unknown character, use replacement character
            result.write('\uFFFD');
          }
          i += 2;
          continue;
        }
      }

      // Single byte ASCII character
      if (byte1 < 0x80) {
        result.writeCharCode(byte1);
      } else {
        // Invalid encoding, use replacement character
        result.write('\uFFFD');
      }
      i++;
    }

    return result.toString();
  }

  /// GBK code to Unicode mapping
  /// This includes common Chinese characters used in stock names
  /// Each GBK code maps to exactly one Unicode codepoint
  static const Map<int, int> _gbkToUnicode = {
    // Common financial terms
    0xBDF0: 0x91D1, // 金
    0xC8DA: 0x878D, // 融
    0xD2F8: 0x94F6, // 银
    0xD0D0: 0x884C, // 行
    0xD6A4: 0x8BC1, // 证
    0xC8AF: 0x5238, // 券
    0xBFD8: 0x63A7, // 控
    0xB9C9: 0x80A1, // 股
    0xB7DD: 0x4EFD, // 份
    0xBCEF: 0x96C6, // 集
    0xCDC5: 0x56E2, // 团
    0xB9AB: 0x516C, // 公
    0xCBBE: 0x53F8, // 司
    0xC6F3: 0x4F01, // 企
    0xD2B5: 0x4E1A, // 业
    0xD7CA: 0x8D44, // 资
    0xB2FA: 0x4EA7, // 产
    0xB1A3: 0x4FDD, // 保
    0xCFD5: 0x9669, // 险
    0xBBF9: 0x57FA, // 基
    0xD0C5: 0x4FE1, // 信
    0xCDD0: 0x6258, // 托
    0xC6DA: 0x671F, // 期
    0xBBF5: 0x8D27, // 货
    0xCDAB: 0x6295, // 投

    // Technology & Electronics
    0xBFC6: 0x79D1, // 科
    0xBCBC: 0x6280, // 技
    0xB5E7: 0x7535, // 电
    0xD7D3: 0x5B50, // 子
    0xC8ED: 0x8F6F, // 软
    0xBCFE: 0x4EF6, // 件
    0xCDF8: 0x7F51, // 网
    0xC2E7: 0x7EDC, // 络
    0xCFA2: 0x606F, // 息
    0xCDBA: 0x901A, // 通
    0xB0EB: 0x534A, // 半
    0xB5BC: 0x5BFC, // 导
    0xCCE5: 0x4F53, // 体
    0xD0BE: 0x82AF, // 芯
    0xC6AC: 0x7247, // 片
    0xD6C7: 0x667A, // 智
    0xC4DC: 0x80FD, // 能
    0xD4C6: 0x4E91, // 云
    0xBCC6: 0x8BA1, // 计
    0xCBE3: 0x7B97, // 算
    0xCAFD: 0x6570, // 数
    0xBEDD: 0x636E, // 据
    0xBBFA: 0x673A, // 机
    0xC6F7: 0x5668, // 器
    0xC8CB: 0x4EBA, // 人

    // Healthcare & Pharmaceutical
    0xD2BD: 0x533B, // 医
    0xD2A9: 0x836F, // 药
    0xC9FA: 0x751F, // 生
    0xCEEF: 0x7269, // 物
    0xBDA1: 0x5065, // 健
    0xBFB5: 0x5EB7, // 康
    0xC6B7: 0x54C1, // 品
    0xC1C6: 0x7597, // 疗
    0xBBF7: 0x5316, // 化
    0xD1A7: 0x5B66, // 学
    0xD6C6: 0x5236, // 制
    0xD4EC: 0x9020, // 造

    // Energy & Resources
    0xD4B4: 0x6E90, // 源
    0xC1A6: 0x529B, // 力
    0xD3CD: 0x6CB9, // 油
    0xC6F8: 0x6C14, // 气
    0xC3BA: 0x7164, // 煤
    0xCCBF: 0x70AD, // 炭
    0xBAD5: 0x6838, // 核
    0xB7E7: 0x98CE, // 风
    0xB9E2: 0x5149, // 光
    0xCCAB: 0x592A, // 太
    0xD1F4: 0x9633, // 阳
    0xD0C2: 0x65B0, // 新

    // Manufacturing & Industry
    0xB9A4: 0x5DE5, // 工
    0xB3A7: 0x5382, // 厂
    0xBFA1: 0x77FF, // 矿
    0xB8D6: 0x94A2, // 钢
    0xCCFA: 0x94C1, // 铁
    0xC2C1: 0x94DD, // 铝
    0xCDAD: 0x94DC, // 铜
    0xD0B5: 0x68B0, // 械
    0xC6FB: 0x6C7D, // 汽
    0xB3B5: 0x8F66, // 车
    0xB7C9: 0x98DE, // 飞
    0xB4AC: 0x8239, // 船
    0xB2B0: 0x8236, // 舶

    // Real Estate & Construction
    0xB7BF: 0x623F, // 房
    0xB5D8: 0x5730, // 地
    0xBDA8: 0x5EFA, // 建
    0xD6FE: 0x7B51, // 筑
    0xB3C7: 0x57CE, // 城
    0xCAD0: 0x5E02, // 市

    // Consumer & Retail
    0xCFD1: 0x6D88, // 消
    0xB7D1: 0x8D39, // 费
    0xC1E3: 0x96F6, // 零
    0xCADB: 0x552E, // 售
    0xC9CC: 0x5546, // 商
    0xB3AC: 0x8D85, // 超
    0xB0D9: 0x767E, // 百
    0xC3C0: 0x7F8E, // 美
    0xCAB3: 0x98DF, // 食
    0xD2FB: 0x996E, // 饮
    0xC1CF: 0x6599, // 料
    0xBEC6: 0x9152, // 酒
    0xC4CC: 0x5976, // 奶
    0xC8E9: 0x4E73, // 乳

    // Transportation & Logistics
    0xBDBB: 0x4EA4, // 交
    0xD4CB: 0x8FD0, // 运
    0xCAE4: 0x8F93, // 输
    0xC1F7: 0x6D41, // 流
    0xB3A1: 0x573A, // 场
    0xB8DB: 0x6E2F, // 港
    0xBFDA: 0x53E3, // 口
    0xBABD: 0x822A, // 航
    0xBFD5: 0x7A7A, // 空
    0xC2B7: 0x8DEF, // 路
    0xB8DF: 0x9AD8, // 高
    0xCBD9: 0x901F, // 速

    // Agriculture
    0xC5A9: 0x519C, // 农
    0xC4C1: 0x7267, // 牧
    0xD3E6: 0x6E14, // 渔
    0xC1D6: 0x6797, // 林
    0xC1B8: 0x7CAE, // 粮
    0xD6D6: 0x79CD, // 种

    // Media & Entertainment
    0xC3BD: 0x5A92, // 媒
    0xCEC4: 0x6587, // 文
    0xBBAF: 0x5316, // 化
    0xD3E9: 0x5A31, // 娱
    0xC0D6: 0x4E50, // 乐
    0xD3B0: 0x5F71, // 影
    0xCAD3: 0x89C6, // 视
    0xD3CE: 0x6E38, // 游
    0xCFB7: 0x620F, // 戏

    // Geographic & Location terms
    0xD6D0: 0x4E2D, // 中
    0xB9FA: 0x56FD, // 国
    0xB1B1: 0x5317, // 北
    0xBEA9: 0x4EAC, // 京
    0xC9CF: 0x4E0A, // 上
    0xBAA3: 0x6D77, // 海
    0xB9E3: 0x5E7F, // 广
    0xD6DD: 0x5DDE, // 州
    0xC9EE: 0x6DF1, // 深
    0xDBDA: 0x5733, // 圳
    0xCCEC: 0x5929, // 天
    0xBDF2: 0x6D25, // 津
    0xD6D8: 0x91CD, // 重
    0xC7EC: 0x5E86, // 庆
    0xC4CF: 0x5357, // 南
    0xCBD5: 0x82CF, // 苏
    0xBDAD: 0x6C5F, // 江
    0xD5E3: 0x6D59, // 浙
    0xB0B2: 0x5B89, // 安
    0xBBD5: 0x5FBD, // 徽
    0xB8A3: 0x798F, // 福
    0xC9BD: 0x5C71, // 山
    0xB6AB: 0x4E1C, // 东
    0xCEF7: 0x897F, // 西
    0xBAD3: 0x6CB3, // 河
    0xBAFE: 0x6E56, // 湖
    0xCBC4: 0x56DB, // 四
    0xB4A8: 0x5DDD, // 川
    0xC9C2: 0x9655, // 陕
    0xB8CA: 0x7518, // 甘
    0xC7E0: 0x9752, // 青
    0xBDAE: 0x7586, // 疆
    0xC3C9: 0x8499, // 蒙
    0xB9C5: 0x53E4, // 古
    0xC1C9: 0x8FBD, // 辽
    0xC4FE: 0x5B81, // 宁
    0xBCAA: 0x5409, // 吉
    0xBADA: 0x9ED1, // 黑
    0xC1FA: 0x9F99, // 龙
    0xCCA8: 0x53F0, // 台
    0xCDE5: 0x6E7E, // 湾
    0xCFE3: 0x9999, // 香
    0xB0C4: 0x6FB3, // 澳
    0xC3C5: 0x95E8, // 门

    // Common adjectives/descriptors in stock names
    0xB4F3: 0x5927, // 大
    0xD0A1: 0x5C0F, // 小
    0xB3A4: 0x957F, // 长
    0xB6CC: 0x77ED, // 短
    0xB5CD: 0x4F4E, // 低
    0xBEC9: 0x65E7, // 旧
    0xBAEC: 0x7EA2, // 红
    0xC0B6: 0x84DD, // 蓝
    0xC2CC: 0x7EFF, // 绿
    0xB0D7: 0x767D, // 白
    0xBBC6: 0x9EC4, // 黄
    0xD7CF: 0x7D2B, // 紫

    // Numbers in Chinese
    0xD2BB: 0x4E00, // 一
    0xB6FE: 0x4E8C, // 二
    0xC8FD: 0x4E09, // 三
    0xCEE5: 0x4E94, // 五
    0xC1F9: 0x516D, // 六
    0xC6DF: 0x4E03, // 七
    0xB0CB: 0x516B, // 八
    0xBEC5: 0x4E5D, // 九
    0xCAE9: 0x5341, // 十
    0xC7A7: 0x5343, // 千
    0xCDF2: 0x4E07, // 万
    0xD2DA: 0x4EBF, // 亿

    // Common characters in company names
    0xC1AA: 0x8054, // 联
    0xBACD: 0x548C, // 和
    0xB9B2: 0x5171, // 共
    0xC3F1: 0x6C11, // 民
    0xD3D1: 0x53CB, // 友
    0xBAC3: 0x597D, // 好
    0xC0FB: 0x5229, // 利
    0xB8BB: 0x5BCC, // 富
    0xBBAA: 0x534E, // 华
    0xD0CB: 0x5174, // 兴
    0xCAA2: 0x76DB, // 盛
    0xB4EF: 0x8FBE, // 达
    0xB3C9: 0x6210, // 成
    0xB7A2: 0x53D1, // 发
    0xD5B9: 0x5C55, // 展
    0xBDAF: 0x8FDB, // 进
    0xB2BD: 0x6B65, // 步
    0xB4B4: 0x521B, // 创
    0xD4AA: 0x5143, // 元
    0xBAE3: 0x6052, // 恒
    0xC8F0: 0x745E, // 瑞
    0xCFA1: 0x7965, // 祥
    0xC6BD: 0x5E73, // 平
    0xCCA9: 0x6CF0, // 泰
    0xC8D9: 0x8363, // 荣
    0xD3C0: 0x6C38, // 永
    0xD6DA: 0x4F17, // 众
    0xC1A2: 0x7ACB, // 立
    0xBBB7: 0x73AF, // 环
    0xBBA4: 0x6CAA, // 沪
    0xD3A2: 0x82F1, // 英

    // Common ETF/Fund terms
    0xB2A9: 0x535A, // 博
    0xCAB1: 0x65F6, // 时
    0xD2D7: 0x6613, // 易
    0xB7BD: 0x65B9, // 方
    0xBCCE: 0x5609, // 嘉
    0xCAB5: 0x5B9E, // 实

    // More common stock name characters
    0xCCD8: 0x7279, // 特
    0xCAA4: 0x8C50, // 胜
    0xC3FB: 0x540D, // 名
    0xC5C6: 0x724C, // 牌
    0xD6CA: 0x8D28, // 质
    0xC1BF: 0x91CF, // 量
    0xBCDB: 0x4EF7, // 价
    0xB8F1: 0x683C, // 格
    0xB2C6: 0x8D22, // 财
    0xCEF1: 0x52A1, // 务
    0xB9DC: 0x7BA1, // 管
    0xC0ED: 0x7406, // 理
    0xB7FE: 0x670D, // 服
    0xD7DC: 0x603B, // 总
    0xB2BF: 0x90E8, // 部

    // Index/Exchange related
    0xD6B8: 0x6307, // 指
    0xCBF9: 0x6240, // 所
    0xCDAA: 0x5B8C, // 完
    0xC8AB: 0x5168, // 全
    0xCFDE: 0x9650, // 限

    // Time-related
    0xC4EA: 0x5E74, // 年
    0xD4C2: 0x6708, // 月
    0xC8D5: 0x65E5, // 日
    0xB7D6: 0x5206, // 分
    0xC3EB: 0x79D2, // 秒

    // Status/State related
    0xD5FD: 0x6B63, // 正
    0xB3A3: 0x5E38, // 常
    0xCDA3: 0x505C, // 停
    0xB8B4: 0x590D, // 复
    0xD5C7: 0x6DA8, // 涨
    0xB5F8: 0x8DCC, // 跌

    // Bonus commonly seen characters
    0xC1EC: 0x9886, // 领
    0xC2BD: 0x9646, // 陆
    0xBEFC: 0x519B, // 军
    0xBCAD: 0x7EDF, // 统
    0xCEAC: 0x7EF4, // 维
    0xD0DE: 0x4FEE, // 修
    0xC2EB: 0x7801, // 码
    0xB1E4: 0x53D8, // 变
    0xBBBB: 0x6362, // 换
    0xB5F7: 0x8C03, // 调
    0xD5FB: 0x6574, // 整
    0xD0AD: 0x534F, // 协
    0xD2E9: 0x8BAE, // 议
    0xC7A9: 0x7B7E, // 签
    0xCAF0: 0x7F72, // 署
    0xB9E6: 0x89C4, // 规
    0xB7B6: 0x8303, // 范
    0xB1EA: 0x6807, // 标
    0xD7BC: 0x51C6, // 准
    0xCFB5: 0x7CFB, // 系
    0xC1D0: 0x5217, // 列
    0xC0E0: 0x7C7B, // 类
    0xBCB6: 0x7EA7, // 级
    0xB1F0: 0x522B, // 别
    0xB4FA: 0x4EE3, // 代
    0xB1E0: 0x7F16, // 编
    0xBAC5: 0x53F7, // 号
    0xB3C6: 0x79F0, // 称
    0xCAF4: 0x5C5E, // 属
    0xD0D4: 0x6027, // 性
    0xCFEE: 0x9879, // 项
    0xC4BF: 0x76EE, // 目
    0xB6A8: 0x5B9A, // 定
    0xD2E5: 0x4E49, // 义
    0xC3F7: 0x660E, // 明
    0xB1B8: 0x5907, // 备
    0xD7A2: 0x6CE8, // 注
    0xB9D8: 0x5173, // 关
    0xBCFC: 0x952E, // 键
    0xD7D6: 0x5B57, // 字
    0xB4CA: 0x8BCD, // 词
    0xBBE3: 0x6C47, // 汇
    0xB1ED: 0x8868, // 表
    0xB5A5: 0x5355, // 单
    0xCFB8: 0x7EC6, // 细
    0xD7B0: 0x88C5, // 装
    0xB1B4: 0x8D1D, // 贝
    0xCDAC: 0x540C, // 同
    0xC7F8: 0x533A, // 区
    0xC1AC: 0x8FDE, // 连
    0xBDCE: 0x63A5, // 接
    0xCAD5: 0x6536, // 收
    0xD2E6: 0x76CA, // 益
    0xCAD6: 0x624B, // 手
    0xB6AF: 0x52A8, // 动
    0xD7D4: 0x81EA, // 自
    0xD6F7: 0x4E3B, // 主
    0xBCC7: 0x8BB0, // 记
    0xC2BC: 0x5F55, // 录
    0xBFAA: 0x5F00, // 开
    0xB3F6: 0x51FA, // 出
    0xC8EB: 0x5165, // 入
    0xCFC2: 0x4E0B, // 下
    0xD7F3: 0x5DE6, // 左
    0xD3D2: 0x53F3, // 右
    0xC7B0: 0x524D, // 前
    0xBAF3: 0x540E, // 后
    0xC0EF: 0x91CC, // 里
    0xCDE2: 0x5916, // 外
    0xBCE4: 0x95F4, // 间
    0xB5BD: 0x5230, // 到
    0xB4D3: 0x4ECE, // 从
    0xD3C3: 0x7528, // 用
    0xD2AA: 0x8981, // 要
    0xC4DA: 0x5185, // 内
    0xB2BB: 0x4E0D, // 不
    0xCAC7: 0x662F, // 是
    0xD3D0: 0x6709, // 有
    0xCEDE: 0x65E0, // 无
    0xD5E2: 0x8FD9, // 这
    0xC4C7: 0x90A3, // 那
    0xCBFC: 0x5B83, // 它
    0xCBFB: 0x4ED6, // 他
    0xCBFD: 0x5979, // 她
    0xCED2: 0x6211, // 我
    0xC4E3: 0x4F60, // 你
    0xD0A3: 0x6821, // 校
    0xD4BA: 0x9662, // 院
    0xD5BE: 0x7AD9, // 站
    0xB5EA: 0x5E97, // 店
    0xBCF2: 0x7B80, // 简
    0xBBD8: 0x56DE, // 回
    0xB4F0: 0x7B54, // 答
    0xCECA: 0x95EE, // 问
    0xCCE2: 0x9898, // 题
    0xB7A8: 0x6CD5, // 法
    0xD4F2: 0x5219, // 则
    0xB5C0: 0x9053, // 道
    0xC2DB: 0x8BBA, // 论
    0xD1D4: 0x8A00, // 言
    0xD3EF: 0x8BED, // 语
    0xD0B4: 0x5199, // 写
    0xB6C1: 0x8BFB, // 读
    0xC8CF: 0x8BA4, // 认
    0xCAB6: 0x8BC6, // 识
    0xBEAD: 0x7ECF, // 经
    0xBCC3: 0x6D4E, // 济
    0xC9E7: 0x793E, // 社
    0xBBE1: 0x4F1A, // 会
    0xD5FE: 0x653F, // 政
    0xB8AE: 0x5E9C, // 府
    0xB5B3: 0x515A, // 党
    0xB6D3: 0x961F, // 队
    0xCBB5: 0x6C34, // 水
  };
}
