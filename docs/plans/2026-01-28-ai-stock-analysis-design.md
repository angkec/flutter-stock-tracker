# AI 选股助手功能设计

## 1. 功能概述

在自选股页面添加「AI 分析」功能，一键将所有自选股的日线和周线数据发送给 DeepSeek AI，获取综合技术分析推荐。

**核心流程：**
1. 用户在自选股页面点击「AI」按钮
2. 检查 API Key 配置，未配置则弹出临时配置框
3. 收集所有自选股的日线（60根）和周线（12根）数据
4. 格式化数据并发送给 DeepSeek API
5. 解析返回结果，在底部弹窗展示推荐列表

## 2. 数据准备

### 2.1 发送给 AI 的数据

每只股票包含：
- 股票代码、名称
- 最近 60 根日 K 线（日期、开高低收、成交量）
- 最近 12 根周 K 线（同上）

### 2.2 数据来源

- 日线：`TdxClient.getSecurityBars(category: 4)`
- 周线：`TdxClient.getSecurityBars(category: 5)`

### 2.3 Prompt 模板

```
你是一个专业的 A 股技术分析师。请分析以下自选股的日线和周线数据，
从技术面（均线、形态、支撑阻力）和量价关系（放量缩量、异动）
综合分析，推荐其中值得关注的股票。

每只推荐的股票给出一句话理由，不超过 30 字。
只推荐有明确买入信号或值得关注的股票，没有就不推荐。

请以 JSON 格式返回：
[
  {"code": "600519", "name": "贵州茅台", "reason": "周线放量突破平台，日线回踩20日均线"},
  ...
]

如果没有推荐，返回空数组 []

=== 股票数据 ===
{股票数据}
```

## 3. UI 设计

### 3.1 入口

自选股页面 AppBar 右侧添加「AI」图标按钮（Icons.auto_awesome）

### 3.2 分析结果弹窗

使用 BottomSheet 展示：

```
┌─────────────────────────────────────────┐
│  AI 选股建议                        ✕   │
├─────────────────────────────────────────┤
│  贵州茅台 (600519)                       │
│  周线放量突破平台，日线回踩20日均线        │
├─────────────────────────────────────────┤
│  宁德时代 (300750)                       │
│  底部放量反转，MACD金叉                   │
├─────────────────────────────────────────┤
│  暂无更多推荐                            │
└─────────────────────────────────────────┘
```

### 3.3 状态处理

| 状态 | 显示内容 |
|------|----------|
| 未配置 API Key | 弹出临时配置框 |
| 加载中 | loading 动画 + "AI 正在分析..." |
| 成功 | 推荐列表 |
| 无推荐 | "当前自选股暂无明确买入信号" |
| 失败 | 错误信息 + 重试按钮 |

## 4. API Key 管理

### 4.1 存储方式

使用 `flutter_secure_storage` 加密存储，Key: `deepseek_api_key`

### 4.2 配置入口

**设置页面（永久配置）：**
- 新增「AI 设置」选项
- 输入框 + 保存按钮
- 已配置时显示脱敏状态（`sk-****`）

**临时配置（点击 AI 按钮时）：**
- 检测到未配置 → 弹出输入框
- 两个选项：「仅本次使用」「保存并使用」
- 「仅本次使用」存在内存中，App 关闭后清除

### 4.3 临时配置弹窗

```
┌─────────────────────────────────────────┐
│  配置 DeepSeek API Key                   │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │ sk-xxxxxxxxxxxxxxxx             │    │
│  └─────────────────────────────────┘    │
│                                         │
│  [ 仅本次使用 ]    [ 保存并使用 ]         │
└─────────────────────────────────────────┘
```

## 5. 技术架构

### 5.1 新增文件

```
lib/
├── services/
│   └── ai_analysis_service.dart    # AI 分析服务
├── models/
│   └── ai_recommendation.dart      # 推荐结果模型
└── widgets/
    └── ai_analysis_sheet.dart      # 底部弹窗组件
```

### 5.2 数据模型

```dart
class AIRecommendation {
  final String stockCode;
  final String stockName;
  final String reason;
}
```

### 5.3 AIAnalysisService

职责：
- 管理 API Key（读取、保存、临时存储）
- 准备数据（收集日线、周线）
- 调用 DeepSeek API
- 解析响应为结构化结果

### 5.4 DeepSeek API 调用

- Endpoint: `https://api.deepseek.com/v1/chat/completions`
- Model: `deepseek-chat`
- 使用 `http` 包发送请求
- 超时设置：60 秒

## 6. 实现步骤

1. 添加 `flutter_secure_storage` 依赖
2. 创建 `AIRecommendation` 模型
3. 创建 `AIAnalysisService` 服务
4. 创建 `AIAnalysisSheet` 弹窗组件
5. 在自选股页面添加 AI 按钮
6. 在设置页面添加 AI 设置入口
7. 集成测试

## 7. 依赖

新增 pubspec.yaml 依赖：
```yaml
flutter_secure_storage: ^9.0.0
```
