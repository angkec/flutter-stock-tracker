# 数据管理页 E2E 防卡住与可预期进度设计

## 1. 背景

当前系统最耗时、问题最集中的是 `数据管理` 页面相关流程（拉取、复检、重算）。
用户核心诉求不是“绝对快”，而是“可预期且不假死”：

- 允许等待，只要界面持续体现业务进展。
- 不能接受无反馈等待。
- 若界面仅有加载动画且超过 5 秒无业务进展信息，必须视为体验缺陷。

## 2. 目标与硬约束

本方案目标是建立可回归验证的质量闸门，保障数据管理页关键流程稳定执行，不再出现“看起来在转圈但没有任何预期”的状态。

硬约束（已确认）：

1. 若连续超过 5 秒没有业务进展信号，判定为“卡住”，测试失败。
2. 业务进展信号定义为：阶段文案变化、`current/total` 变化、百分比变化。
3. 单纯加载动画不算业务进展。
4. 若加载动画持续超过 5 秒，UI 必须提供更明确的进度预期信息（任一合适形式即可）。

## 3. 方案比较与选型

### A. 纯黑盒 UI 观察

只看 UI 文案/进度变化，不观察底层事件。
优点是贴近用户，缺点是故障定位慢、误报概率较高。

### B. 双轨观测（采用）

主判定仍以 UI 业务进展为准，同时记录 `statusStream/onProgress` 事件时间线用于诊断。
优点：满足用户感知标准，且能快速定位“流程没推进”与“UI没展示”两类问题。

### C. 先做状态机重构再测

长期收益高，但当前投入过大，不满足快速兜底目标。

最终采用 B：先建立可执行的防卡住回归，再逐步优化内部结构。

## 4. 分层测试架构

### 4.1 离线主回归（主力）

使用可控 fake 依赖驱动数据管理页，覆盖全关键链路与异常分支，保证高稳定、可重复、可 CI。

覆盖重点：

- 历史分钟K：拉取缺失、强制重拉、失败处理
- 周K：拉取缺失、强制重拉、MACD 预热路径
- 日K：强制重拉与阶段进度展示
- 完整性复检：清缓存后重检与结果提示
- 前置校验：市场数据为空时的拦截提示

统一断言：任一长流程中，连续 5 秒无业务进展信号即失败。

### 4.2 真网络全量复验（收尾）

在离线改动全部完成后，按同一场景矩阵进行真网络全量复验。

- 用于验证真实链路（网络、磁盘、连接池）下的表现。
- 不改变“5 秒无业务进展即失败”的规则。
- 放宽总耗时预算，但不放宽“可预期进度”要求。

## 5. 进度可预期设计要求

当操作耗时较长时，界面至少要提供以下任一组合，确保用户有预期：

- 阶段名称
- `current/total`
- 百分比
- （可选）速率、最近进展时间、ETA

最低要求是“能判断现在在做什么、大概做了多少、是否还在推进”。

## 6. 故障分类与回归策略

将失败分为三类：

1. **真实卡住**：底层与 UI 都无进展。
2. **展示缺陷**：底层有推进，但 UI 5 秒内无业务进展体现。
3. **业务异常**：流程抛错、弹窗未关闭、按钮未恢复可操作。

策略：每次 E2E 暴露问题，都补一条对应 unit/widget 测试，之后再修复，防止回归。

## 7. 验收标准

1. 数据管理页关键流程全部可自动化执行并收敛到可观察终态。
2. 任何关键流程都不能出现“仅转圈且超过 5 秒无业务进展”。
3. 失败分支也必须正确结束（关闭进度弹窗、显示错误提示、页面可继续操作）。
4. 离线主回归通过后，真网络全量复验通过。

## 8. 执行顺序

1. 先补离线 E2E 基建（watchdog + driver + fake 进度源）。
2. 按场景矩阵补全离线 E2E 与卡住断言。
3. 将暴露问题下沉为 unit/widget 防回归。
4. 完成离线修改后执行真网络全量复验并记录结果。

## 9. 非目标

本次不做以下内容，避免范围失控：

- 不重写数据管理页整体架构。
- 不引入新的复杂状态机框架。
- 不追求一次性优化所有数据拉取性能问题。

本次只聚焦：建立“不会无预期等待”的硬性质量保障。
