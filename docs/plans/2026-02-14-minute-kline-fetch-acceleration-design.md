# 分钟K线抓取加速设计（全量 + 增量）

## 1. 背景与目标

当前分钟K线抓取链路存在以下性能问题：

- 仓库层虽有并发窗口，但底层单连接请求锁导致实际吞吐接近串行。
- 抓取流程中存在重复校验与重复读写，放大了 I/O 开销。
- 后续刷新未充分利用“已完成状态”，增量效率不稳定。

本设计的目标（已确认）：

- **覆盖范围**：全量 A 股。
- **首次全量抓取**：可接受约 **5 分钟**。
- **后续刷新**：必须以增量为主，避免重复全量拉取。
- **两阶段交付**：先达成目标（Phase 1），再评估存储层深度优化（Phase 2）。

## 2. 设计原则

- **先计划再执行**：先计算最小必要抓取集，再发起网络请求。
- **真并发而非伪并发**：通过连接池实现多连接并行吞吐。
- **批量提交状态**：减少“每股抓完立刻复检”的重复成本。
- **增量优先**：以每股同步水位驱动刷新窗口。
- **可回退可观测**：关键参数可配置，链路可灰度回退。

## 3. 总体架构

在现有 `MarketDataRepository` 基础上新增三类组件：

1. `TdxPoolFetchAdapter`
   - 封装 `TdxPool` 的分钟K并行抓取能力。
   - 提供统一接口（如 `fetchMinuteBarsBatch(...)`）。
   - 负责连接健康检查、任务分发、重试与限流。

2. `MinuteSyncPlanner`
   - 输入：`tradingDates`、`date_check_status`、`minute_sync_state`。
   - 输出：按股票划分的抓取计划（无需抓取 / 近端增量 / 历史补洞）。

3. `MinuteSyncWriter`
   - 负责批量写入分钟K、批量更新 metadata 与版本号。
   - 统一触发受影响日期范围复检并推进同步状态。

> 兼容性要求：上层 UI 与服务调用入口尽量保持不变。

## 4. 数据模型扩展

新增状态表：`minute_sync_state`（轻量状态）

建议字段：

- `stock_code`（PK）
- `last_complete_trading_day`
- `last_success_fetch_at`
- `last_attempt_at`
- `consecutive_failures`
- `last_error`
- `updated_at`

用途：

- 计算每只股票“从哪天开始增量抓取”。
- 对连续失败股票进行节流与优先补偿。
- 提升增量命中率并减少无效请求。

## 5. 核心数据流

### 5.1 首次全量路径（Bootstrap）

1. 读取交易日基线。
2. `MinuteSyncPlanner` 将全部股票标记为 `bootstrap`。
3. `TdxPoolFetchAdapter` 并发抓取分钟K（按分片调度）。
4. `MinuteSyncWriter` 批量写入并更新版本。
5. 批量复检受影响日期，写入 `minute_sync_state`。

### 5.2 日常增量路径（Incremental）

1. 根据 `last_complete_trading_day` 计算最小增量窗口（通常 1–2 交易日）。
2. 仅抓取未确认或不完整日期。
3. 批量写入 + 批量复检 + 状态推进。
4. 对失败股票记录失败上下文，下一轮优先补偿。

## 6. 并发与容错策略

默认建议（可配置）：

- `poolSize = 8`（建议调节区间 6–10）。
- 每连接 `1` 个飞行请求（与底层连接锁语义一致）。
- 全局 in-flight 上限约 `8`。
- 股票分片大小建议 `120–200`。

失败处理：

- **瞬时失败**：同连接重试 1 次；失败后换连接再试 1 次。
- **连接级失败**：剔除坏连接并异步补建。
- **股票级失败**：累加 `consecutive_failures`，当轮跳过，后续补偿。

## 7. 性能预算与指标

预算目标：

- 网络抓取：70%–80%
- 写盘：15%–25%
- 复检/状态提交：5%–10%

验收指标（Phase 1）：

- 首次全A股全量（20天分钟K）：`P50 <= 5 分钟`，`P95 <= 7 分钟`。
- 日常增量刷新：`P50 <= 60 秒`，`P95 <= 120 秒`。
- 单轮失败率 `< 1.5%`，下一轮可自动补偿。
- 增量命中率稳定后 `> 85%`。

## 8. 测试方案

1. 单元测试
   - `MinuteSyncPlanner`：首次/增量/补洞的计划正确性。
   - `TdxPoolFetchAdapter`：重试、连接剔除、降速行为。

2. 集成测试
   - 扩展真实网络 smoke：50/200 只样本，记录吞吐与失败分布。

3. 回归测试
   - 验证 `checkFreshness`、`findMissingMinuteDates` 语义不回退。
   - 验证 UI 仍正确反映数据状态。

## 9. 交付与灰度

### Phase 1（必做）

- 新增抓取适配器、计划器、写入器。
- 引入 `minute_sync_state` 与增量调度。
- 先灰度增量路径，再切换全量路径。
- 保留运行时开关，支持一键回退旧链路。

### Phase 2（可选增强）

- 优化分钟K存储为 append-friendly 结构。
- 减少整月文件重写与反复解压成本。
- 进一步压低全量与补历史场景耗时。

## 10. 风险与缓解

- **风险：连接池并发过高导致失败率上升**
  - 缓解：动态限流 + 失败率触发降速。

- **风险：状态推进错误导致漏抓**
  - 缓解：批量复检后再推进 `last_complete_trading_day`。

- **风险：灰度期间新旧链路状态不一致**
  - 缓解：统一写入层与版本事件，保持同一事实源。

