# 个股详情联动双K设计（周K + 日K）

## 1. 背景与目标

当前个股详情中，`日线` 与 `周线` 通过分段按钮切换，用户在反复观察同一只股票时，需要在脑中手动完成两件事：

- 时间对齐：某一天属于哪一周，切到周K后很难瞬间定位。
- 价格对齐：当前关注价格在另一个周期中的位置与结构关系不直观。

本次新增一个独立的 `联动` 模式（不替换现有分时/日线/周线），目标是让用户“长按一次就同时看懂两种周期”。

确认后的核心体验：

1. 布局固定为 **上周K + 下日K**。
2. 任一图长按/滑动时，另一图自动同步到对应时间。
3. 增加 **价格横线联动**：以手指纵向位置反算价格，两图同时显示同一价格线。
4. 目标图若当前纵轴不含该价格，自动微调纵轴保证横线可见。
5. 手势优先级：仅长按期间激活联动，松手恢复普通浏览。

---

## 2. UI 视觉方向（frontend-design）

### 2.1 设计定位

采用“**交易仪表盘（Industrial Precision）**”风格：克制、锐利、信息密度高，不走花哨卡片化路线。强调“精确映射”的可信度，而不是装饰感。

可记忆的视觉锚点（本模式的 signature）：

- 一条贯穿双图的“**同步价格轨**”（同色、同值、同节奏）。
- 周K与日K在该价格处同时响应，形成“同价不同周期”的瞬时对照。

### 2.2 视觉系统（在现有主题上增强）

- 色彩：延续现有涨跌语义（红涨绿跌），联动状态新增单一强调色（推荐青色系）用于十字线/价格轨/联动标签。
- 文本：标题层级保持现有风格，数值区（价格、涨跌幅、时间）统一采用 `tabular figures`，减少跳动。
- 结构：双图容器采用“上轻下重”比例（42% / 58%），下方日K承担细节解释。
- 动效：联动激活时仅做轻量过渡（120–160ms），避免炫技动画造成交易场景的延迟感。

### 2.3 交互可视反馈

- 长按激活后，图角显示 `联动中` 胶囊标签；松手消失。
- 顶部信息条同时展示：`日期映射`（周→日或日→周）+ `同步价格`。
- 当目标图发生自动纵轴微调时，显示极轻提示（如 `已自动对齐价格范围`，1s 内淡出）。

---

## 3. 信息架构与组件边界

在 `StockDetailScreen` 增加 `ChartMode.linked`。进入该模式时，渲染新组件 `LinkedDualKlineView`：

1. `LinkedDualKlineView`（容器）
   - 接收 `dailyBars`、`weeklyBars`、`ratioHistory`。
   - 组织上周下日布局与顶部联动状态栏。

2. `LinkedCoordinator`（状态协调器）
   - 管理共享联动状态：
     - `anchorDate`：时间锚点
     - `anchorPrice`：价格锚点
     - `sourcePane`：当前手势源（weekly/daily）
     - `isLinking`：是否处于长按联动中

3. `KLineChart`（最小增量扩展）
   - 保留现有单图能力。
   - 新增可选联动参数（不传即保持旧行为）：
     - 外部注入联动十字线状态
     - 回传触摸事件（日期、价格、索引、手势生命周期）
     - 接收“目标日期/价格”并执行对齐

该边界设计可保证：联动逻辑集中，不污染原有日线/周线模式，回归风险最低。

---

## 4. 联动数据流与映射规则

### 4.1 源图事件

源图长按开始/移动时产生：

- `date`：由 x 命中的 K 线索引映射
- `price`：由 y 与当前可视纵轴反算
- `sourcePane`：`weekly` 或 `daily`

协调器更新共享状态并广播到两图。

### 4.2 时间映射

- 日 → 周：以 `weekKey(year-weekOfYear)` 定位对应周K。
- 周 → 日：优先定位该周最后交易日；缺失时回退到该周最近交易日。

说明：禁止“直接按索引硬匹配”，避免数据长度差异导致错位。

### 4.3 价格映射

- 价格锚点始终以**当前手指 y 反算值**为准。
- 另一图接收同一价格值后绘制横线。
- 如该价格不在另一图当前纵轴范围内，自动扩展纵轴至“包含锚点价 + 安全边距（建议 8%）”。

### 4.4 防抖与一致性

- 仅长按生命周期内同步；松手清理覆盖层。
- 采用单帧源优先（`sourcePane`）策略，避免双向回调抖动。
- 纵轴微调设置最小变更阈值，抑制频繁重算。

---

## 5. 页面与控件改动

## 5.1 模式入口

`SegmentedButton` 从：

- 分时 / 日线 / 周线

扩展为：

- 分时 / 日线 / 周线 / 联动

## 5.2 联动模式结构

从上到下：

1. 联动状态条（日期映射 + 同步价格 + 轻提示）
2. 周K图（约 42% 高度）
3. 分隔间距（8–12px，兼顾手势边界）
4. 日K图（约 58% 高度）

## 5.3 图层规则

- 两图都显示纵向十字线 + 横向价格线。
- 横线颜色/粗细一致，形成单一视觉通道。
- 周K图保留结构洞察；日K图保留突破标记、量比等细节信息。

---

## 6. 异常与边界处理

1. 数据缺失
   - 周/日映射失败时回退到最近交易日并提示 `已对齐最近交易日`。

2. 极端价格
   - 反算价格超界先 `clamp` 再扩轴，横线必须可见。

3. 无数据状态
   - 任一图为空时联动模式降级为单图提示，不进入联动手势。

4. 性能保护
   - 联动渲染优先走局部刷新（`ValueNotifier` 或等价机制），避免整页 `setState`。

---

## 7. 实现拆分（建议）

1. `lib/screens/stock_detail_screen.dart`
   - 新增 `ChartMode.linked`
   - 在 `_buildChart()` 分支中挂载 `LinkedDualKlineView`

2. `lib/widgets/linked_dual_kline_view.dart`（新增）
   - 承载布局、协调器、状态条与双图绑定

3. `lib/widgets/kline_chart.dart`
   - 增加联动所需可选参数与回调
   - 保证默认参数下行为与当前完全一致

4. （可选）`lib/widgets/linked_crosshair_models.dart`（新增）
   - 收敛 `LinkedCrosshairState`、`LinkedTouchEvent` 数据结构

---

## 8. 测试与验收

### 8.1 单元测试

- `weekKey` 映射与周→日回退逻辑正确。
- 自动纵轴扩展包含锚点价且满足边距。

### 8.2 组件测试

- 上图长按：下图同步日期与价格线。
- 下图长按：上图同步日期与价格线。
- 松手：联动覆盖层清空。

### 8.3 回归测试

- 分时/日线/周线原有功能与手势不回退。
- 日线突破标记与检测浮层仍可用。

### 8.4 验收标准

1. 用户可在 1 次长按中完成周日对应与同价对照。
2. 联动滑动过程无明显抖动或错位。
3. 切换到联动模式不会破坏既有模式与数据加载流程。

---

## 9. 后续扩展（非本次必做）

- 增加“锁定联动”开关（非长按临时态）。
- 支持月K或60分钟K纳入多周期联动。
- 允许用户自定义上下图顺序与高度配比。

