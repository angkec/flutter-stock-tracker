# 行业排名趋势设计

## 概述

在现有行业tab中增加行业每日排名趋势功能，用分钟K量比对行业进行每日排名，通过sparkline展示排名变化趋势，帮助用户快速识别：
- **热门区**：排名靠前、可能过热的行业
- **回升区**：量比开始抬升、主力可能在建仓的行业

## 数据计算层

### 行业量比计算

对每个行业、每一天，从缓存的分钟K数据汇总：

```
行业涨量 = Σ 行业内所有个股的涨量（收盘>开盘的分钟K成交量之和）
行业跌量 = Σ 行业内所有个股的跌量（收盘<开盘的分钟K成交量之和）
行业量比 = 行业涨量 / 行业跌量
```

### 排名生成

- 每天对所有行业按量比降序排名（量比越高排名越前）
- 历史数据：从缓存的分钟K数据回算并持久化存储
- 当天数据：用实时分钟K数据计算

### 存储格式

本地持久化，结构：
```json
{
  "2025-01-20": {
    "半导体": { "ratio": 2.3, "rank": 5 },
    "新能源": { "ratio": 2.15, "rank": 2 },
    ...
  },
  ...
}
```

### 数据流

1. 启动时加载已存储的历史排名数据
2. 检查是否有缺失的交易日 → 用缓存分钟K补算并存储
3. 当天用实时分钟数据计算，合并到序列末尾

## UI展示层

### 行业tab增强布局

在现有行业页面顶部新增排名趋势区域：

```
┌──────────────────────────────────┐
│  [5日]  [10日]  [20日]  [自定义]   │  ← 快速切换按钮组
├──────────────────────────────────┤
│  排名  行业名     量比   趋势       │
│  1↑3   半导体    2.31   ╱──       │  ← sparkline显示排名走势
│  2↓1   新能源    2.15   ──╲╱      │
│  3↑7   军工      1.98   ╱─        │
│  4→    白酒      1.85   ───       │
│  5↑2   医药      1.72   ╱         │
│  ...                              │
└──────────────────────────────────┘
```

### 每行信息

- 当前排名
- 排名变化标记（↑N / ↓N / →）— 与N天前相比
- 行业名称
- 当前量比值
- Sparkline — 排名趋势线（Y轴倒置，排名上升线条向上）

### 区域颜色标识

- **热门区（红/橙色背景）**— 当前排名在前N名（可配置，默认前5）
- **回升区（蓝/青色背景）**— 同时满足：
  - 当前排名不在热门区
  - 量比相比N天前有明显抬升（涨幅超过配置阈值，如+30%）

### 排序方式

- 默认按当前排名排序
- 可切换为"按排名提升幅度"排序 — 快速找到近期上升最快的行业

### 交互

- 点击行业行 → 进入现有的行业详情页
- 时间段快速切换：底部按钮组 5日 / 10日 / 20日 / 自定义

## 实现架构

### 新增文件

- `lib/services/industry_rank_service.dart` — 核心计算和存储逻辑
- `lib/models/industry_rank.dart` — 数据模型
- `lib/widgets/industry_rank_list.dart` — 排名趋势列表组件（含sparkline）

### 数据模型

```dart
class IndustryRankRecord {
  final String date;
  final double ratio;      // 当天量比
  final int rank;          // 当天排名
}

class IndustryRankHistory {
  final String industryName;
  final List<IndustryRankRecord> records;  // 按日期排序
  int get rankChange => records.first.rank - records.last.rank; // 正数=上升
}
```

### IndustryRankService职责

1. `calculateDayRank(String date)` — 从缓存分钟K计算某天所有行业量比并排名
2. `loadHistory()` / `saveHistory()` — 本地持久化
3. `getRankHistory(int days)` — 获取最近N天的排名数据
4. `fillMissingDays()` — 检查并补算缺失交易日

### 配置项

```
热门区：排名前 [5] 名
回升区：排名 [6-20] 且量比较 [5] 天前增长 [30%] 以上
时间段：[5] / [10] / [20] / 自定义天数
```

### 与现有代码的集成

- 在 `MarketDataProvider` 刷新完成后触发排名计算
- `IndustryScreen` 顶部嵌入 `IndustryRankList` 组件
- 复用现有的 `IndustryService` 获取行业分类信息

## 边界情况

- **非交易日**：排名序列只包含交易日，跳过周末和节假日
- **数据缺失**：某天分钟K缓存不存在 → 跳过该天，sparkline中断点连线
- **行业无成交**：全部停牌 → 量比记为0，排名垫底
- **性能**：历史排名计算只在首次或数据更新时执行，结果持久化；当天实时计算跟随60秒刷新周期；数据量大时在Isolate中计算
