# 新交易日增量数据验证与改造设计

## 1. 背景与目标

当前数据管理链路已经具备基础拉取与重算能力，但在“新交易日”边界下仍缺乏系统化保障，主要风险包括：日内未收盘数据是否可参与计算、收盘后完整数据能否覆盖日内不完整结果、以及覆盖过程是否会引入长时间不可预期等待。本方案目标是将这些规则收敛为可测试、可观测、可回归的统一机制，并通过 `Unit 为主 + E2E 抽样` 的测试策略实现高覆盖。

硬目标：

1. 新交易日日内数据可增量计算并对外可见。
2. 交易日终了后，完整日线可强覆盖日内不完整数据。
3. 所有计算必须走增量路径，禁止终盘触发全量重算。
4. 超过 5 秒的长任务必须持续给出可预期进度，不允许“无反馈等待”。

本设计以数据源市场日历为准，不在本地写死交易所收盘时间或时区规则。

## 2. 方案比较与选型

### A. 在现有流程打补丁

优点是改动小、上线快。缺点是规则分散在拉取、计算、缓存多个入口，后续很难保证一致性，测试矩阵也会持续膨胀。

### B. 统一状态机 + 判定器 + 覆盖协调器（采用）

引入 `交易日状态机`、`完整性判定器`、`终盘覆盖协调器`，把“partial/final 判定”“何时覆盖”“如何增量重算”统一在一个入口。优点是规则集中、可注入、可完整做 Unit 覆盖；E2E 只需验证关键主链路。

### C. 双轨永久并存（intraday/final）

审计能力强，但数据模型和查询复杂度显著上升，不适合本次以稳定性和回归保障为主的目标。

最终采用方案 B。

## 3. 核心架构与数据流

新增四个核心组件（均支持依赖注入）：

1. `Clock`：统一当前时间来源，便于测试时控制时间推进。
2. `MarketCalendarProvider`：从数据源市场日历获取交易日、收盘状态、节假日信息。
3. `CandleCompletenessClassifier`：对新拉取日线打 `partial/final/unknown` 与 `reason`。
4. `FinalOverrideCoordinator`：根据交易日状态和数据完整性决定是否触发强覆盖。

流程如下：

1. 拉取新数据后，先经 `Classifier` 判定完整性，采用“来源标记优先、结构规则兜底”的混合策略。
2. `Coordinator` 查询市场日历判断当前交易日状态：
   - 未终盘：允许 `partial` 进入增量计算并标记临时版本。
   - 已终盘且拿到 `final`：触发同标的同交易日强覆盖。
3. 覆盖通过事务完成：先写 K 线，再写增量指标结果，最后切换可见版本指针，避免半完成可见。
4. 查询端只读取可见版本指针对应快照，保证一致性。

建议引入幂等键与版本语义：

- 幂等键：`symbol + trade_date + version_type`
- 版本：`intraday_vN`、`final_v1`

## 4. 增量重算策略（硬约束）

本方案将“禁止全量重算”设为硬规则。`FinalOverrideCoordinator` 只能提交 `DirtyRange` 增量任务，不能调用全量路径。

`DirtyRange` 定义建议：

- 维度：`symbol + timeframe + trade_date`
- 作用：标记受影响最小重算窗口

指标计算策略：

1. MACD/EMA 类：从 `trade_date - warmup_span` 到 `trade_date` 续算，不回扫全历史。
2. MA 类：按窗口长度向前最小回溯。
3. 排名/聚合：仅重算受影响交易日及其依赖窗口，不触发历史全量刷新。

性能保护：

1. 单次窗口超过阈值时自动拆批，批次串行或受控并行执行。
2. 每批输出阶段进度（任务数、完成数、当前阶段），避免长时间无反馈。
3. 指标引擎对外暴露“全量接口禁用开关”，在该场景直接 fail-fast，防止误用。

## 5. 错误处理与回退

### 分类失败（unknown）

当来源标记缺失且结构规则也无法判定时，标记 `unknown`，不触发终盘覆盖，保留当前可见版本并进入重试队列。

### 增量计算失败

覆盖任务失败时不切换可见版本指针，旧版本继续可读；同时记录 `dirty` 与错误原因，后台指数退避重试。

### 事务中断

若在“K 线已写入但指标未完成”阶段失败，事务回滚，禁止出现“数据与指标不一致”的可见状态。

### UI 可预期反馈

长任务必须展示阶段化进度（拉取、判定、增量计算、切换版本），并提供最少一类量化信号（`current/total` 或百分比）。可选展示 ETA，但不可展示“仅加载动画”超过 5 秒无变化。

## 6. 测试设计

### 6.1 Unit 测试（主力）

1. **状态机矩阵**：
   - `pre-open / intraday / post-close-pending-final / post-close-finalized`
   - 输入 `partial/final/unknown`
   - 断言：是否允许计算、是否标记 dirty、是否触发覆盖
2. **增量正确性**：
   - 固定历史基线后注入当日增量
   - 断言增量结果与离线全量基准在误差阈值内一致
   - 强制断言未调用全量接口
3. **幂等与乱序**：
   - 重复 final、partial->final->partial 乱序
   - 断言可见版本不回退、事务一致
4. **失败回退**：
   - 分类失败、计算失败、事务失败
   - 断言可见版本稳定、重试任务正确排队

### 6.2 E2E 抽样（关键链路）

1. 新交易日日内拉取后可见增量结果，UI 有阶段进度。
2. 终盘后 final 到达，触发强覆盖与增量重算，详情页读取最新快照。
3. 网络抖动下重试可恢复，且不出现超过 5 秒无业务反馈。

### 6.3 性能回归门槛

为关键阶段记录耗时并按样本统计 `median/p95`。门槛不做绝对值硬编码到单次 run，而是以基线回归阈值判定，避免偶发网络抖动导致误报。

## 7. 验收标准

1. 新交易日日内数据可计算并可读，收盘后 final 可覆盖 intraday。
2. 覆盖全程不触发全量重算，只执行受影响增量窗口。
3. 可见版本始终一致，不出现半更新状态。
4. Unit 覆盖所有关键状态与失败分支；E2E 抽样主链路通过。
5. 任何长任务都不存在“超过 5 秒无业务反馈”的等待体验。

## 8. 实施边界

本轮不做：

1. 重写整套历史数据模型。
2. 引入双轨永久存储架构。
3. 一次性优化所有市场全部指标的全局性能。

本轮聚焦：建立新交易日增量链路的正确性、可预期性与可回归性。
