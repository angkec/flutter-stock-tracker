# 周K数据持久化与管理设计（2026-02-15）

## 背景

当前周K数据主要在个股详情页临时拉取，未进入统一数据仓库，导致：

- 无法在数据管理页面统一维护周K缓存
- 难以复用到后续指标计算
- 周K同步行为与日K/分钟K分离

目标是将周K纳入现有分层架构（UI → Service → Repository → Storage），并在数据管理页“基础数据”区新增一行管理入口。

## 需求约束

- 范围：全市场
- 触发方式：手动触发
- 数据量目标：每只股票至少保留 100 周（实现上采用约 760 天窗口）
- 管理入口：数据管理页“基础数据”区新增“周K数据”行
- 交互：同时支持“拉取缺失”和“强制重拉”

## 架构方案

### 数据层

- 扩展 `KLineDataType`，新增 `weekly`
- 在 `MarketDataRepository` 增加 `weekly -> TDX category 5` 映射
- 复用现有 `KLineMetadataManager + KLineFileStorage` 持久化链路
- 为周K增量拉取增加覆盖预检查：
  - 若本地元数据已覆盖目标时间窗（含 7 天新鲜度容差），则跳过拉取
  - 否则进入拉取

### 展示层

- `DataManagementScreen` 基础数据区新增“周K数据”卡片
- 状态信息展示：样本覆盖数/目标 100 周
- 操作：
  - `拉取缺失` -> `fetchMissingData(..., dataType: weekly)`
  - `强制重拉` -> `refetchData(..., dataType: weekly)`

## 验证策略

- 仓库测试：确认 `weekly` 使用 `category=5`
- 页面测试：确认“周K数据”行可触发“拉取缺失”和“强制重拉”
- 回归测试：更新数据管理页面既有测试，避免新增周K行影响旧断言

