# A股涨跌量比监控系统 - 设计文档

## 1. 产品概述

实时监控全市场A股的涨跌量比指标，帮助识别资金流向偏买入的股票。

## 2. 核心指标

### 2.1 涨跌量比定义

```
涨量 = 所有上涨分钟(close > open)的成交量之和
跌量 = 所有下跌分钟(close < open)的成交量之和
涨跌量比 = 涨量 / 跌量
```

- **平盘处理**: `close == open` 的分钟不计入涨量也不计入跌量
- **跌量为0**: 涨跌量比设为 999（显示为 ∞）

### 2.2 双时间维度

| 指标 | 说明 |
|------|------|
| `ratio_day` | 当日开盘至今的涨跌量比 |
| `ratio_30m` | 最近30根1分钟K线的涨跌量比 |

如果当日K线不足30根，`ratio_30m` 使用已有数据计算，并标记 `*`。

## 3. 数据源

### 3.1 数据接口 (mootdx)

| 接口 | 用途 | 参数 |
|------|------|------|
| `client.stocks(market)` | 获取股票列表 | market: 0=深圳, 1=上海 |
| `client.bars(symbol, frequency, offset)` | 获取分钟K线 | frequency=8 (1分钟), offset=250 |
| `client.quotes(symbol)` | 获取实时行情 | symbol: 股票代码列表 (每批最多80只) |

### 3.2 A股代码前缀

| 市场 | 前缀 | 说明 |
|------|------|------|
| 深圳 | 000, 001, 002, 003 | 主板 |
| 深圳 | 300, 301 | 创业板 |
| 上海 | 600, 601, 603, 605 | 主板 |
| 上海 | 688 | 科创板 |

### 3.3 行情数据字段

```
{
  "code": "000001",
  "name": "平安银行",
  "price": 11.12,        // 当前价
  "last_close": 11.19,   // 昨收价
  "change_pct": -0.63,   // 涨跌幅 (%)
  "volume": 123456789,   // 成交量
  "ratio_day": 1.14,     // 日涨跌量比
  "ratio_30m": 1.85      // 30分钟涨跌量比
}
```

## 4. 数据过滤规则

按顺序过滤，保留有效股票：

### 4.1 基础过滤

| 条件 | 过滤原因 |
|------|----------|
| `price <= 0` | 无效数据 |
| `volume == 0` | 停牌 |

### 4.2 涨跌停过滤

不同股票涨跌停幅度不同，接近涨跌停的股票会产生极端量比，需过滤：

| 股票类型 | 涨跌停幅度 | 判断规则 |
|----------|------------|----------|
| ST股票 (名称含"ST") | ±5% | `abs(change_pct) >= 4.5%` |
| 创业板/科创板 (300/301/688) | ±20% | `abs(change_pct) >= 19.5%` |
| 主板 (其他) | ±10% | `abs(change_pct) >= 9.5%` |

容差 0.5% 用于处理涨跌停价格四舍五入。

## 5. 界面设计

### 5.1 布局结构

```
┌─────────────────────────────────────────────────────────┐
│ 标题栏: 产品名 | 更新时间 | 延迟 | 市场状态 | 加载进度  │
├─────────────────────────────────────────────────────────┤
│ 自选股列表 (来自配置文件)                                │
│ ┌─────┬──────┬──────┬───────┬─────────┬──────────┐     │
│ │代码 │ 名称 │ 现价 │ 涨跌% │ 日涨跌比│ 30m涨跌比│     │
│ └─────┴──────┴──────┴───────┴─────────┴──────────┘     │
├─────────────────────────────────────────────────────────┤
│ 全市场 Top 20 (按日涨跌比降序)                          │
│ ┌─────┬──────┬──────┬───────┬─────────┬──────────┐     │
│ │代码 │ 名称 │ 现价 │ 涨跌% │ 日涨跌比│ 30m涨跌比│     │
│ └─────┴──────┴──────┴───────┴─────────┴──────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 5.2 颜色规则 (A股风格)

| 元素 | 条件 | 颜色 |
|------|------|------|
| 涨跌% | > 0 | 红色 |
| 涨跌% | < 0 | 绿色 |
| 涨跌% | = 0 | 默认 |
| 量比 | > 1 | 红色 |
| 量比 | < 1 | 绿色 |
| 量比 | = 1 | 默认 |

### 5.3 特殊显示

- 量比 ≥ 999 显示为 `∞`
- 30分钟数据不足时，量比后加 `*` 标记

## 6. 市场状态

根据当前时间判断：

| 时间段 | 状态 |
|--------|------|
| 周六日 | 周末休市 |
| < 09:30 | 盘前 |
| 09:30 - 11:30 | 交易中 |
| 11:30 - 13:00 | 午休 |
| 13:00 - 15:00 | 交易中 |
| > 15:00 | 已收盘 |

## 7. 数据加载策略

### 7.1 优先级加载

1. **优先加载自选股** (~1秒)
   - 立即显示自选股数据
   - 状态显示 `(0/5000)`

2. **分批加载全市场** (~1-2分钟)
   - 每批 500 只股票
   - 进度更新 `(500/5000)` → `(1000/5000)` → ...
   - Top 20 列表随每批数据实时更新

### 7.2 刷新机制

- 刷新间隔: 60秒
- 刷新时保持旧数据显示，不清屏
- 只在新数据获取成功后更新

## 8. 配置文件

### 8.1 自选股配置 (watchlist.txt)

```
000001
600519
300750
```

- 每行一个股票代码
- 空行自动忽略
- 文件不存在时只显示全市场 Top 20

## 9. 技术参数

| 参数 | 值 | 说明 |
|------|-----|------|
| TOP_N | 20 | 全市场显示前N只 |
| REFRESH_INTERVAL | 60 | 刷新间隔(秒) |
| MAX_WORKERS | 15 | 并发请求数 |
| BATCH_SIZE | 500 | 每批加载股票数 |
| QUOTES_BATCH | 80 | 行情接口每批限制 |

## 10. 数据处理流程

```
┌─────────────┐
│ 获取股票列表 │
└──────┬──────┘
       ↓
┌─────────────────┐
│ 分离自选股/其他  │
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 1. 获取自选股K线 │ ──→ 显示自选股
└──────┬──────────┘
       ↓
┌─────────────────────┐
│ 2. 分批获取其他K线   │ ──→ 每批更新进度和Top20
│    (每批500只)      │
└──────┬──────────────┘
       ↓
┌─────────────────┐
│ 3. 获取实时行情  │ (每批80只，自动分批)
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 4. 计算涨跌量比  │
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 5. 过滤无效数据  │ (停牌、涨跌停)
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 6. 排序并显示    │ (按ratio_day降序)
└─────────────────┘
```

## 11. 错误处理

| 场景 | 处理方式 |
|------|----------|
| 单只股票获取失败 | 跳过，不影响其他 |
| 行情接口返回空 | 该批次跳过 |
| 网络超时 | 保持旧数据显示 |
| 配置文件不存在 | 只显示全市场数据 |
